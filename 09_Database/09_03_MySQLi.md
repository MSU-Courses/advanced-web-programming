# Работа с функциями MySQLi

Для взаимодействия PHP с базой данных MySQL одно из базовых средств – расширение MySQLi [^2] (_MySQL Improved_). Рассмотрим шаги работы с базой данных через MySQLi в процедурном стиле.

## Подключение к базе данных

Первым шагом при работе с базой данных является установление соединения с сервером СУБД. Для MySQL в PHP используется функция `mysqli_connect()`.

**Синтаксис**:

```php
mysqli_connect(host, username, password, database, port, socket);
```

- `host` – адрес сервера базы данных (обычно `localhost`).
- `username` – имя пользователя для подключения к базе данных.
- `password` – пароль пользователя.
- `database` – имя базы данных, к которой вы хотите подключиться.
- `port` – (необязательный) порт, на котором работает сервер базы данных (по умолчанию 3306).
- `socket` – (необязательный) путь к сокету, если используется локальное соединение.
- Возвращает объект соединения при успешном подключении или `false` в случае ошибки.

**Пример**. _Подключение к базе данных_

```php
<?php

$host = "localhost";   // адрес сервера MySQL (обычно localhost)
$user = "root";        // имя пользователя БД
$pass = "";            // пароль (по умолчанию пустой для root в OpenServer/XAMPP)
$db   = "my_database"; // имя базы данных

$conn = mysqli_connect($host, $user, $pass, $db);

if (!$conn) {
    // Ошибка при подключении – выводим сообщение и завершаем работу скрипта
    // Так как без подключения к БД дальнейшие действия невозможны
    die("Ошибка: Невозможно подключиться к MySQL. " . mysqli_connect_error());
}

// Устанавливаем кодировку соединения UTF-8
mysqli_set_charset($conn, "utf8");
```

В данном примере:

- Мы определяем параметры подключения (`$host`, `$user`, `$pass`, `$db`). В учебных или локальных средах часто используется пользователь `root` без пароля на `localhost`. В реальных условиях данные доступа будут другими (и обычно хранятся вне кода).
- Вызываем `mysqli_connect()`. Если соединение успешно, функция вернёт специальный объект (идентификатор соединения). В случае неудачи она возвращает `false​` [^1].
- После успешного подключения рекомендуется установить кодировку соединения UTF-8 с помощью `mysqli_set_charset()`, чтобы корректно работать с русским языком и другими Unicode-символами.
- `mysqli_connect_error()` возвращает текст ошибки, если подключение не удалось.

> [!NOTE]
> На этом этапе осуществляется только подключение к серверу базы данных. Предполагается, что база данных `my_database` уже создана и у пользователя есть к ней доступ. Если указанные учётные данные неверны или сервер MySQL не запущен, подключение завершится с ошибкой.

### Пользовательская функция подключения

Для упрощения подключения к базе данных можно создать пользовательскую функцию, которая будет принимать параметры подключения и возвращать объект соединения.

**Пример**. _Функция подключения к базе данных_

```php
<?php

function connectToDatabase($host, $user, $pass, $db) {
    $conn = mysqli_connect($host, $user, $pass, $db);

    if (!$conn) {
        die("Ошибка: Невозможно подключиться к MySQL. " . mysqli_connect_error());
    }

    mysqli_set_charset($conn, "utf8");
    return $conn;
}
```

## Выполнение SQL-запросов

Имея активное соединение с базой данных, вы можете выполнять SQL-запросы с помощью функции `mysqli_query()`.

Синтаксис функции:

```php
mysqli_query(connection, query, resultmode);
```

- `connection` — идентификатор соединения, полученный при вызове `mysqli_connect()`.
- `query` — SQL-запрос в виде строки.
- `resultmode` – (необязательный) режим результата. О
  - `MYSQLI_STORE_RESULT` (по умолчанию) — загружает все результаты в память.
  - `MYSQLI_USE_RESULT` — использует потоковую обработку, подходит для работы с большими наборами данных.
- Возвращает:
  - объект результата (`mysqli_result`) — для запросов, возвращающих данные (например, SELECT);
  - `true` — для успешных запросов без возвращаемых данных (`INSERT`, `UPDATE`, `DELETE`, `CREATE TABLE` и т.д.);
  - `false` — в случае ошибки.

### Создание таблицы MySQLi

Для создания таблицы используется SQL-оператор `CREATE TABLE`. В MySQLi он выполняется так же, как и любой другой запрос.

**Пример**. _Создание таблицы_

```php
<?php

$sql = "CREATE TABLE IF NOT EXISTS users (
    id INT(11) AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)";

if (mysqli_query($conn, $sql)) {
    echo "Таблица users успешно создана.";
} else {
    echo "Ошибка создания таблицы: " . mysqli_error($conn);
}
```

В данном примере:

- Таблица `users` создаётся только в том случае, если она ещё не существует (`IF NOT EXISTS`).
- Поле `id` является первичным ключом и автоматически увеличивается при добавлении новых записей.
- `username` и `email` — обязательные текстовые поля.
- `created_at` — автоматически устанавливается в текущее время при добавлении записи.

> [!TIP]
> Хорошей практикой является проверка результата выполнения запроса и вывод понятного сообщения об ошибке, как показано в примере выше.

Хотя процесс создания таблицы является важным, в реальных проектах таблицы, как правило, не создаются вручную в каждом скрипте. Обычно они создаются один раз — на этапе инициализации базы данных. В дальнейшем эти таблицы используются для хранения, обработки и анализа данных. Для управления структурой базы данных и автоматизации подобных операций применяются **миграции**, о которых мы подробнее поговорим позже.

### Выборка данных (`SELECT`)

Предположим, есть таблица `users` с полями `id`, `name` и `email`, и мы хотим получить все записи из этой таблицы.

Разберём пошагово, как выполнить SQL-запрос на выборку данных в MySQLi:

#### 1. Формирование запроса и выполнение

Необходимо составить SQL-запрос и передать его в функцию `mysqli_query()`. В случае ошибки выводится сообщение, и выполнение скрипта прерывается:

```php
<?php

$sql = "SELECT id, name, email FROM users";
$result = mysqli_query($conn, $sql);

if ($result === false) {
    // Запрос не выполнился (синтаксическая ошибка или др.)
    echo "Ошибка при выполнении запроса: " . mysqli_error($conn);
    exit();
}
```

Функция `mysqli_query()` возвращает объект результата, содержащий строки, соответствующие запросу. Однако этот объект нельзя напрямую отобразить — его необходимо обработать.

#### 2. Получение данных из результата

Для извлечения всех строк из результата используется функция `mysqli_fetch_all()`:

```php
$users = mysqli_fetch_all($result, MYSQLI_ASSOC);
```

- Константа `MYSQLI_ASSOC` указывает, что каждая строка будет представлена в виде ассоциативного массива (`['id' => ..., 'name' => ..., 'email' => ...]`).
- В качестве альтернативы можно использовать:
  - `MYSQLI_NUM` — для получения числового индекса массива (`[0 => ..., 1 => ..., 2 => ...]`).
  - `MYSQLI_BOTH` — для получения обоих типов индексов (`[0 => ..., 'id' => ..., 1 => ..., 'name' => ..., 2 => ..., 'email' => ...]`).

#### 3. Перебор и вывод данных

Извлечённые данные можно отобразить с помощью цикла `foreach`:

```php
foreach ($users as $user) {
    echo "ID: {$user['id']}, Имя: {$user['name']}, Email: {$user['email']}<br>";
}
```

Либо использовать построчную обработку с помощью `while` и `mysqli_fetch_assoc()`:

```php
while ($user = mysqli_fetch_assoc($result)) {
    echo "ID: {$user['id']}, Имя: {$user['name']}, Email: {$user['email']}<br>";
}
```

> [!TIP]
> Построчная обработка может быть предпочтительнее при работе с большим количеством данных.

#### 4. Освобождение ресурсов

По завершении работы с результатом необходимо освободить занятую память:

```php
// Освобождаем ресурс результата
mysqli_free_result($result);
```

> [!IMPORTANT]
> Освобождение ресурсов особенно важно при работе с большими результатами или при использовании потокового режима (`MYSQLI_USE_RESULT`).

#### Пример: Генерация `<option>` для `<select>`

Например, для генерации списка пользователей в выпадающем списке `<select>` можно использовать следующий код:

```php
<?php

function generateSelectOptions() {
    global $conn; // Используем глобальную переменную соединения
    $sql = "SELECT id, name FROM users";
    $result = mysqli_query($conn, $sql);

    if ($result === false) {
        echo "Ошибка при выполнении запроса: " . mysqli_error($conn);
        return;
    }

    $options = mysqli_fetch_all($result, MYSQLI_ASSOC);
    mysqli_free_result($result);

    $optionsHtml = '';
    foreach ($options as $option) {
        $optionsHtml .= "<option value=\"{$option['id']}\">{$option['name']}</option>";
    }
    return $optionsHtml;
}
?>

<select name="user_id">
    <?php echo generateSelectOptions(); ?>
</select>
```

В этом примере:

- Функция `generateSelectOptions()` выполняет SQL-запрос на выборку всех пользователей.
- Результат преобразуется в HTML-код для `<option>`, который затем вставляется в `<select>`.
- Используется глобальная переменная `$conn` для доступа к соединению с базой данных.
- В случае ошибки выполнения запроса выводится сообщение, и функция завершает работу.
- После завершения работы с результатом освобождаются ресурсы.

### Вставка данных (`INSERT`)

Добавление новой записи выполняется SQL-командой `INSERT`.

#### 1. Формирование запроса

```php
<?php

$name = "Ivan Ivanov";
$email = "ivan@gmail.com";
$sql = "INSERT INTO users (name, email) VALUES ('$name', '$email')";
```

- Команда `INSERT INTO` указывает таблицу (`users`) и поля, в которые необходимо вставить данные.
- Значения передаются напрямую в запрос — в данном случае это переменные `$name` и `$email`, заключённые в кавычки.

> [!WARNING]
> Прямое включение пользовательского ввода в SQL-запрос может привести к SQL-инъекциям — одному из самых опасных типов уязвимостей. Подробнее о безопасной вставке данных будет рассказано в следующем разделе.

#### 2. Выполнение запроса

```php
$result = mysqli_query($conn, $sql);

if ($result) {
    // Получаем ID вставленной записи
    $newId = mysqli_insert_id($conn);
    echo "Новый пользователь успешно добавлен, ID = $newId";
} else {
    echo "Ошибка при вставке: " . mysqli_error($conn);
}
```

- Функция `mysqli_query()` выполняет SQL-запрос на вставку.
- Если запрос выполнен успешно, можно получить ID новой записи, сгенерированный полем `AUTO_INCREMENT`, с помощью функции `mysqli_insert_id($conn)`.
- В примере результат выводится на экран, включая ID новой записи.

> [!IMPORTANT]
> Вспомним, что в реальных приложениях сообщение об ошибке базы данных не должно отображаться пользователю. Вместо этого его следует записывать в лог, а пользователю выводить общее уведомление: _"Произошла ошибка при добавлении данных. Повторите попытку позже."_

### Обновление и удаление данных (`UPDATE` и `DELETE`)

Обновление и удаление записей в базе данных выполняются с помощью SQL-команд `UPDATE` и `DELETE`, аналогично вставке данных через `INSERT`.

#### 1. Обновление данных

```php
<?php

$id = 1; // ID пользователя, которого нужно обновить
$newEmail = "ivan.petrov@gmail.com"; // Новый email

$sql = "UPDATE users SET email = '$newEmail' WHERE id = $id";
$result = mysqli_query($conn, $sql);

if (mysqli_affected_rows($conn) > 0) {
    echo "Пользователь с ID $id успешно обновлён.";
} else {
    echo "Ошибка обновления: " . mysqli_error($conn);
}
```

- Команда `UPDATE` изменяет данные в таблице users, устанавливая новое значение поля `email` для пользователя с заданным `id`.
- Функция `mysqli_affected_rows()` возвращает количество строк, затронутых последним запросом. Если значение больше 0, обновление прошло успешно.
- При отсутствии изменений (_например_, указано то же значение, что уже хранится в базе), результатом может быть `0`.

#### 2. Удаление данных

```php
<?php

$id = 5;

$sql = "DELETE FROM users WHERE id = $id";
$result = mysqli_query($conn, $sql);

if (mysqli_affected_rows($conn) > 0) {
    echo "Пользователь с ID $id успешно удалён.";
} else {
    echo "Ошибка удаления: " . mysqli_error($conn);
}
```

- Команда `DELETE` удаляет строку из таблицы users, где `id` соответствует заданному значению.
- После выполнения запроса `mysqli_affected_rows()` позволяет убедиться, что строка действительно была удалена (то есть пользователь с таким `id` существовал).

> [!WARNING]
> Всегда проверяйте наличие условия `WHERE` в запросах на обновление и удаление. Отсутствие этого условия может привести к критическим последствиям. Например, запрос `DELETE FROM users` удалит всех пользователей из таблицы. Поэтому перед выполнением запросов стоит внимательно проверять логику и значения переменных.

[^1]: _Работа с MySQL в PHP_. htmlacademy [online resource]. Available at: https://htmlacademy.ru/blog/php/mysql˝
[^2]: _MySQLi_. php.net [online resource]. Available at: https://www.php.net/manual/ru/book.mysqli.php