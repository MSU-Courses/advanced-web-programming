# Введение в миграции базы данных

> [!NOTE]
> Эта глава является дополнительным и предназначен для тех, кто хочет углубить знания.

В процессе разработки приложения структура базы данных (таблицы, поля, типы данных, связи и ограничения) часто изменяется: добавляются новые таблицы, поля, индексы, меняются типы и правила. Миграции позволяют управлять такими изменениями последовательно и контролируемо.

**Миграция** — это файл (SQL или скрипт), описывающий, как перевести базу данных из одного состояния в другое.

## Зачем нужны миграции?

- **Версионирование базы**. Миграции позволяют вести учёт всех изменений в структуре БД, так же как система контроля версий отслеживает изменения в коде. Это даёт возможность понять, кто и когда внёс изменения в схему.
- **Командная разработка**. Каждый разработчик может применять миграции и получать актуальную версию базы без ручного вмешательства. Это исключает ситуации, когда структура БД на локальной машине отличается от общей.
- **Деплой на разные окружения**. При переносе приложения на другие среды (dev, staging, production) миграции позволяют легко и безопасно обновить базу данных, применив все нужные изменения в правильной последовательности.
- **Откат изменений**. Некоторые системы миграций поддерживают откат (`rollback`) — возможность отменить последнее изменение, если оно оказалось ошибочным.

## Как реализуются миграции?

В самом простом виде миграция — это SQL-файл. Например:

```sql
-- файл: 20250401_create_users_table.sql
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100) NOT NULL UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

По имени файла видно, что таблица users создана 1 апреля 2025 года. Принято использовать префикс с датой или номером, чтобы определить порядок применения миграций.

Такие файлы можно вручную запускать через `phpMyAdmin`, `mysql`, `psql` или другие клиенты. Однако ручное применение неудобно и подвержено ошибкам, особенно в команде или при частых изменениях.

## Инструменты для миграций в PHP

Существуют готовые решения, которые упрощают управление миграциями:

- Phinx [^1] — один из самых популярных инструментов миграций в PHP-проектах без фреймворков. **Позволяет**:

  - генерировать миграции на PHP или SQL;
  - применять (migrate) и откатывать (rollback) изменения;
  - отслеживать состояние миграций.

- migrate [^2] - мигратор баз данных (_CLI-утилита_), написанный на Go, поддерживает работу с различными СУБД. **Позволяет**:

  - генерировать файлы миграций на чистом SQL;
  - применять (migrate) и откатывать (rollback) изменения;
  - отслеживать состояние миграций.

  Несмотря, что это не PHP-решение, его можно использовать в проектах на PHP, так как он поддерживает работу с MySQL и PostgreSQL.

Если вы пока не используете фреймворки или сторонние инструменты, можно начать с простого:

- Создавайте SQL-файлы с изменениями (create_table_users.sql, alter_table_add_status.sql и т.п.);
- Храните их в отдельной папке (migrations/);
- Упорядочивайте по времени создания;
- Обменивайтесь этими файлами с коллегами;
- Документируйте, какие изменения применялись и когда.

[^1]: _Phinx_. phinx.org [online resource]. Available at: https://phinx.org
[^2]: _migrate_. github.com [online resource]. Available at: https://github.com/golang-migrate/migrate
