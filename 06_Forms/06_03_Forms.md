# Обработка форм в PHP

## Использование форм как способ взаимодействия с пользователем

Один из самых распространённых способов взаимодействия с пользователем в веб-приложениях — это использование **форм**.

Вспомним некоторые понятия из курса по `HTML`:

- **Форма** — это элемент HTML `<form>`, который позволяет пользователю вводить данные и отправлять их на сервер. Она состоит из элементов управления (`controls`), меток (`labels`), кнопки отправки и других элементов.
- **Элементы управления** (controls) — это поля ввода, такие как текстовые поля, флажки, радиокнопки, выпадающие списки и другие. Они позволяют пользователю вводить данные, которые затем отправляются на сервер.
- **Метки** (labels) — это текстовые метки, которые описывают, что нужно ввести в поле. Они улучшают доступность и удобство использования формы.
- **Кнопка отправки** — это элемент `<button type="submit">`, который после нажатия отправляет данные формы на сервер.

**Пример**. _Форма отзыва на сайте_:

<img src="https://imgur.com/hL2yQkl.png" width="500" />

Если рассматривать взаимодействие пользователя с веб-приложением через формы, то можно выделить следующий процесс:

```
Пользователь вводит данные в форму
    -> Нажимает кнопку отправки
        -> Данные отправляются на сервер
            -> Сервер обрабатывает данные и возвращает ответ
                -> Отображается результат
```

Таким образом, основной процесс взаимодействия с пользователем в веб-приложении через формы сводится к отправке данных на сервер и обновлению интерфейса на основе полученного ответа.

В этой главе мы подробно изучим работу с формами и их использование в веб-приложениях, включая:

- Создание и настройку HTML-форм
- Обработку данных на сервере
- Валидацию пользовательского ввода
- Защиту от различных видов атак

Эти знания помогут вам создавать более удобные и безопасные веб-приложения.

## Атрибуты элемента `<form>`

Рассмотрим базовый пример формы. Вы изучали атрибуты формы в курсе по `HTML`, вспомним основные из них.

```html
<form
  method="post"
  action="/handler.php"
  novalidate
  autocomplete="off"
  enctype="multipart/form-data"
>
  <label for="name">Имя:</label>
  <input type="text" id="name" name="name" required />

  <label for="email">Email:</label>
  <input type="email" id="email" name="email" required />

  <label for="message">Сообщение:</label>
  <textarea id="message" name="message" required></textarea>

  <button type="submit">Отправить</button>
</form>
```

Тег `<form>` объявляет начало HTML-формы. У этого тега есть несколько атрибутов.

**Ключевые атрибуты формы**:

- `method="post"` — метод отправки данных. Может принимать значение `"GET"` или `"POST"`. От этого зависит, как именно браузер отправит данные на сервер. Если метод не указан, по умолчанию используется `GET`.
- `action="/handler"` — адрес серверного скрипта или страницы, на которую отправятся данные формы. Как только пользователь нажимает кнопку отправки, браузер перейдет по этому адресу, передав введенные данные. Обычно здесь указывают файл PHP, который будет обрабатывать данные. Например, `action="hanlder.php"` отправит данные на `http://my-site.com/handler.php`.
- `novalidate` — отключает встроенную валидацию браузера, что позволяет применять собственную серверную валидацию.
- `autocomplete="off"` — отключает автозаполнение браузером, что полезно для повышения безопасности.
- `enctype="multipart/form-data"` — используется при отправке файлов или бинарных данных.

### Описание аттрибутов

| Атрибут          | Описание                                                                                           | Пример                                 |
| ---------------- | -------------------------------------------------------------------------------------------------- | -------------------------------------- |
| `target`         | Определяет, где будет открыт ответ (`_blank`, `_self`, `_parent`, `_top`).                         | `<form target="_blank">`               |
| `name`           | Имя формы (может использоваться в JavaScript).                                                     | `<form name="feedback">`               |
| `id`             | Уникальный идентификатор формы (используется для CSS и JS).                                        | `<form id="feedback">`                 |
| `accept-charset` | Указывает кодировку, которую сервер использует для обработки данных.                               | `<form accept-charset="UTF-8">`        |
| `novalidate`     | Отключает встроенную валидацию браузера.                                                           | `<form novalidate>`                    |
| `autocomplete`   | Включает (`on`) или отключает (`off`) автозаполнение формы.                                        | `<form autocomplete="off">`            |
| `enctype`        | Тип кодирования данных (`application/x-www-form-urlencoded`, `multipart/form-data`, `text/plain`). | `<form enctype="multipart/form-data">` |

## Элементы управления формы

Внутри формы мы размещаем поля, куда пользователь вводит информацию. В дальнейшем введеные данные будут переданы на сервер.

Самый распространенный элемент – тег `<input>`. Он позволяет создавать различные поля ввода, такие как _текстовые поля_, _флажки_, _радиокнопки_ и другие.

### Атрибуты элемента `<input>`

Самые распространенные атрибуты элемента `<input>`:

- `type` – тип поля. Определяет, что это за поле ввода. Самые базовые типы:
  - `"text"` (текстовое поле),
  - `"password"` (парольное поле, вводимые символы скрыты),
  - `"number"` (поле для ввода чисел),
  - `"email"` (поле для ввода email-адреса),
  - др.
- `name` – имя поля. **Крайне важно!** Имя идентифицирует поле, и именно по этому имени сервер будет потом получать значение. **Если у поля нет атрибута `name`, то значение этого поля не будет передано на сервер**.
- `value` – значение по умолчанию (необязательный атрибут, позволяет задать предварительное значение поля, которое пользователь увидит и сможет изменить).

Помимо `<input>`, существуют и другие элементы для ввода, такие как `<textarea>` (многострочное текстовое поле) или элементы выбора (`<select>`). Мы рассмотрим их в следующих разделах главы.

## Отправка формы

После того, как была создана форма и пользователь ввел данные, необходимо отправить эти данные на сервер для дальнейшей обработки.

Для отправки данных формы на сервер используется кнопка отправки (`<button type="submit">`).

**Пример.** _Форма отправки комментария_

```html
<form action="/handler.php" method="get">
  <label for="name">Имя:</label>
  <input type="text" id="name" name="name" required />

  <label for="email">Email:</label>
  <input type="email" id="email" name="email" required />

  <label for="message">Сообщение:</label>
  <textarea id="message" name="message" required></textarea>

  <button type="submit">Отправить</button>
</form>
```

В данном примере: когда пользователь заполняет форму и нажимает кнопку **Отправить**, данные из полей ввода отправляются на сервер по указанному URL (`action`). В данном случае, когда пользователь заполнит эти поля и нажмет **"Отправить"**, браузер отправит запрос по адресу `/handler.php` (например, если это `localhost`, то `http://localhost/handler.php`), передав данные из формы.

#### Важность атрибута `name`

Как было сказано ранее, атрибут `name` является ключевым для отправки данных на сервер. Он определяет **ключ**, под которым данные будут переданы на сервер.

**Например**: если у поля ввода `name="email"`, то данные из этого поля будут отправлены на сервер с ключом `email`.

Если пользователь ввёл `email: john@gmail.com`, сервер получит данные в виде пары "ключ=значение":

```http
email=john@gmail.com
```

> [!IMPORTANT]
> Если данные не имеют атрибута `name`, они не будут отправлены на сервер.

## Методы отправки данных

После того, как пользователь отправил данные формы, нам необходимо определить, как именно эти данные будут отправлены на сервер.

HTML-формы поддерживают два основных метода передачи данных (атрибут `method`):

1. **GET**
2. **POST**

Рассмотрим методы отправки данных на основе примера выше: _форма отправки комментария_.

### Метод `GET`

Метод `GET` отправляет данные через `URL` (адресную строку). Это означает, что все пары **"ключ=значение"** отправляемых полей приклеиваются к адресу страницы в формате `"query parameters"` (параметры запроса).

#### Что происходит при отправке данных методом `GET`?

1. Предположим, пользователь ввел следующие данные в форму:

   - `name: John`
   - `email: john@gmail.com`
   - `message: Hello World`

2. Браузер отправляет запрос, на URL указаннй в `action` (например, `handler.php`) и добавляет к нему вопросительный знак `?`, после которого перечисляет все поля и их значения в формате `имя=значение`, разделяя пары амперсандом `&` если полей несколько

3. В итоге, браузер отправит данные на сервер в виде URL-строки:

   ```http
   http://my-site.com/handler.php?name=John&email=john%40gmail.com&message=Hello%20World
   ```

**В данном примере**:

- `?` — разделитель URL и данных.
- `&` — разделитель между параметрами.
- Спецсимволы (`@`, пробел) кодируются (`%40`, `%20`).

> [!TIP]
> Как упоминалось ранее, ключи данных формируются на основе атрибута `name` каждого поля формы.

<img src="https://imgur.com/WwPdtd1.png" width="500" />

#### Характерные особенности метода `GET`

- Отправляемые данные видны в адресной строке после отправки (их может увидеть пользователь и даже скопировать этот URL).
- Объем данных ограничен длиной URL. В разных браузерах максимальная длина URL может быть разной, но обычно она составляет 2048 символов.
- **Подходит** для **поисковых запросов, фильтров, сортировки**. Например, `/search?query=apple`, `/products?category=phones`, `/products?sort=price`.
- **Не подходит** для **отправки больших данных или конфиденциальной информации**, например паролей. Поскольку данные видны в адресе, они остаются в истории браузера, могут попасть в логи сервера или быть просмотрены посторонними.

### Метод `POST`

Метод `POST` отправляет данные _"невидимо"_, в **теле HTTP-запроса**.

При нажатии кнопки браузер формирует запрос к серверу, но параметры не прикрепляет к URL, а вкладывает внутрь (в так называемое _тело запроса_).

#### Что происходит при отправке данных методом `GET`?

1. Предположим, пользователь ввел следующие данные в форму:

   - `name: John`
   - `email: john@gmail.com`
   - `message: Hello World`

2. Браузер обращается на указанный в `action` адрес и отправляет данные в теле запроса:

   ```http
   POST /handler.php HTTP/1.1
   Content-Type: application/x-www-form-urlencoded

   name=John&email=john@gmail.com&message=Hello%20World
   ```

3. В отличие от `GET`, данные скрыты и не отображаются в URL.

#### Характерные особенности метода `POST`

- Данные не видны в адресной строке и не сохраняются в истории. Это более безопасно для передачи, например, паролей или личных сообщений пользователя.
- Нет жесткого ограничения на объем данных (формально ограничение определяется настройками сервера). Поэтому `POST` используют для больших форм, файл-аплоадов и т.д.
- URL остается _"чистым"_. Нельзя напрямую поделиться ссылкой с уже заполненными данными.
- **Подходит** для **форм регистрации, авторизации, отправки файлов**.
- **Не подходит**, если данные должны быть доступны через URL (например, для `поиска`, `сортировки`, `фильтрации`, и т.д.).

### Что выбрать: `GET` или `POST`?

| Метод  | Когда использовать                                                                                          | Когда не использовать                                             |
| ------ | ----------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------- |
| `GET`  | Для выполнения поисковых запросов, фильтрации и сортировки данных                                           | Для передачи больших объемов данных и конфиденциальной информации |
| `POST` | В остальных случаях, включая отправку форм, загрузку файлов и другие операции, изменяющие состояние сервера | Для поисковых запросов, фильтрации и сортировки данных            |

## Получение и обработка данных

Мы научились создавать форму и знаем, как она она отправляет данные на сервер. Теперь переходим к приему и обработке данных на стороне сервера с помощью PHP.

Предположим, у нас уже есть HTML-форма (например, как в примере выше), которая отправляет данные на некий PHP-скрипт (в атрибуте `action`). Как же нам вытащить отправленные значения внутри этого скрипта?

### Получение данных из формы

PHP обрабатывает данные, отправленные формой, с помощью **суперглобальных массивов** — специальных массивов, доступных во всех частях скрипта. Они содержат данные формы, заголовки HTTP-запросов, параметры сессий и другую информацию.

Для работы с формами используются два суперглобальных массива: `$_GET` и `$_POST`. Они автоматически заполняются PHP при отправке формы:

- `$_GET` — содержит данные, переданные через URL-строку (`method="get"`).
- `$_POST` — содержит данные, переданные скрыто в теле запроса (`method="post"`).
- `$_FILES` — используется для обработки загруженных файлов (рассматрим в следующих разделах).

Рассмотрим форму отправки отзыва и получение данных из неё.

**Пример**. _Форма отправки отзыва_

```html
<form action="/handler.php" method="post">
  <label for="name">Имя:</label>
  <input type="text" id="name" name="name" required />

  <label for="email">Email:</label>
  <input type="email" id="email" name="email" required />

  <label for="message">Сообщение:</label>
  <textarea id="message" name="message" required></textarea>

  <button type="submit">Отправить</button>
</form>
```

#### Получение данных из формы методом `GET`

Если в форме используется `method="get"`, данные передаются через URL и доступны в массиве `$_GET`:

**Пример**. _Получение данных из формы методом `GET`_

```php
// Массив $_GET
[
  'name' => 'John',
  'email' => 'john@gmail.com',
  'message' => 'Hello World',
]
```

Чтобы получить данные из формы, используем ключи массива `$_GET`:

```php
$name = $_GET['name']; // Получаем значение поля name
$email = $_GET['email']; // Получаем значение поля email
$message = $_GET['message']; // Получаем значение поля message
```

#### Получение данных из формы методом `POST`

Если указан `method="post"`, данные передаются скрыто в теле запроса и доступны через `$_POST`:

**Пример**. _Получение данных из формы методом `POST`_

```php
// Массив $_POST
[
  'name' => 'John',
  'email' => 'john@gmail.com',
  'message' => 'Hello World',
]
```

Чтобы получить данные из формы, используем ключи массива `$_POST`:

```php
// handler.php
$name = $_POST['name']; // Получаем значение поля name
$email = $_POST['email']; // Получаем значение поля email
$message = $_POST['message']; // Получаем значение поля message
```

> [!TIP]
> В PHP разница между `GET` и `POST` заключается только в способе передачи данных. Если изменить метод формы с `GET` на `POST`, обращаться к данным нужно через `$_POST` вместо `$_GET` и наоборот.

### Обработка данных формы

Получение данных из формы — это только первый шаг. Далее их нужно обработать: сохранить, отправить на почту, отобразить на экране или выполнить другие действия.

Разберем обработку данных на примере формы отправки отзыва.

### Проверка, была ли форма отправлена

Перед обработкой данных нужно убедиться, что форма была отправлена. Для этого проверяем метод запроса. Наиболее распространенный способ — это проверка, что был отправлен запрос методом `POST`.

`$_SERVER` — суперглобальный массив с информацией о сервере и текущем запросе. `$_SERVER['REQUEST_METHOD']` содержит метод запроса (`GET`, `POST` и т. д.).

> [!TIP]
> Суперглобальный массив `$_SERVER` содержит множество полезной информации о текущем запросе, включая метод запроса (`REQUEST_METHOD`), URL (`REQUEST_URI`), IP-адрес клиента (`REMOTE_ADDR`), имя текущего скрипта (`PHP_SELF`) и другие.

```php
// Проверяем, была ли форма отправлена
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // Форма отправлена
}
```

### Получение данных из формы

После проверки метода запроса можно получить данные. Для этого используются суперглобальные массивы `$_POST` или `$_GET`.

```php
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // Получаем данные из формы
    $formData = [
        'name' => $_POST['name'],
        'email' => $_POST['email'],
        'message' => $_POST['message'],
    ];
}
```

### Обработка данных

Полученные данные можно использовать:

- Сохранить в базу данных
- Отправить на почту
- Вывести на экран
- Записать в файл
- друие действия.

```php
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $formData = [
        'name' => $_POST['name'] ?? '',
        'email' => $_POST['email'] ?? '',
        'message' => $_POST['message'] ?? '',
    ];

    // Пример обработки — сохранение в файл txt,
    // где каждая строка — это отдельное сообщение в формате JSON
    file_put_contents('messages.txt', json_encode($formData) . PHP_EOL, FILE_APPEND);
}
```

### Отправка ответа

После обработки данных необходимо сообщить пользователю результат.

```php
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $formData = [
        'name' => $_POST['name'] ?? '',
        'email' => $_POST['email'] ?? '',
        'message' => $_POST['message'] ?? '',
    ];

    // Дальнейшая обработка данных

    echo 'Данные успешно отправлены!';
}
```

### Где обрабатывать данные?

При работе с формами важно определить, где именно обрабатывать отправленные данные. То есть, что указать в атрибуте `action`, чтобы обработка была корректной и удобной.

На начальном этапе, пока не изучены более сложные подходы к разработке веб-приложений, рекомендуется обрабатывать данные в том же файле, где расположена форма. Это упрощает тестирование и помогает быстро убедиться в правильности работы.

**Пример**. _Обработка данных формы в том же файле_

В этом случае форма отправляет данные на тот же файл, где она расположена.

```php
<?php
// index.php

<?php
// index.php

// Проверяем, была ли отправлена форма
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // Получаем данные из формы
    $formData = [
        'name' => $_POST['name'] ?? '',
        'email' => $_POST['email'] ?? '',
        'message' => $_POST['message'] ?? '',
    ];

    // Дальнейшая обработка данных (например, сохранение в базе данных)
}
?>

<!-- Форма -->
<form action="" method="post">
  <input type="text" name="name" required>
  <input type="email" name="email" required>
  <textarea name="message" required></textarea>
  <button type="submit">Отправить</button>
</form>
```

При желании можно вынести обработку данных в отдельный файл, например, `handler.php`, подключив его к основному файлу с формой.

**Пример**. _Обработка данных формы в отдельном файле_

```php
<?php

// handler.php

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $formData = [
        'name' => $_POST['name'],
        'email' => $_POST['email'],
        'message' => $_POST['message'],
    ];

    // Делаем что-то с данными
    // Например, сохраняем в базу данных
    // Или отправляем на почту
    // Или выводим на экран
}
?>
```

```php
<?php
// index.php

// Подключаем обработчик
require_once 'handler.php';
?>

<!-- Форма -->
<form action="/index.php" method="post">
  <!-- Поля формы -->
</form>
```

Часто в качестве `action` используется `$_SERVER['PHP_SELF']`, что позволяет форме отправлять данные на тот же файл, в котором она находится.

Если форма находится в `index.php`, `$_SERVER['PHP_SELF']` вернет `/index.php`, а если в `handler.php` — `/handler.php`. Это удобно, так как при изменении имени файла обновлять action не придется.

То есть, если сменится адрес файла, форма будет отправлять данные на новый адрес.

**Пример**. _Использование `$_SERVER['PHP_SELF']`_

```php
<?php require_once 'handler.php'; ?>

<form action="<?php echo $_SERVER['PHP_SELF']; ?>" method="post">
  <!-- Поля формы -->
</form>
```

[^1]: _HTML Form_. programiz [online resource]. Available at: https://www.programiz.com/html/form
