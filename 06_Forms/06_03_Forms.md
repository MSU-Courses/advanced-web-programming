# Обработка форм в PHP

## Использование форм как способ взаимодействия с пользователем

Один из самых распространённых способов взаимодействия с пользователем в веб-приложениях — это использование **форм**.

Вспомним некоторые понятия из курса по `HTML`:

- **Форма** — это элемент HTML `<form>`, который позволяет пользователю вводить данные и отправлять их на сервер. Она состоит из элементов управления (`controls`), меток (`labels`), кнопки отправки и других элементов.
- **Элементы управления** (controls) — это поля ввода, такие как текстовые поля, флажки, радиокнопки, выпадающие списки и другие. Они позволяют пользователю вводить данные, которые затем отправляются на сервер.
- **Метки** (labels) — это текстовые метки, которые описывают, что нужно ввести в поле. Они улучшают доступность и удобство использования формы.
- **Кнопка отправки** — это элемент `<button type="submit">`, который после нажатия отправляет данные формы на сервер.

**Пример**. _Форма отзыва на сайте_:

<img src="https://imgur.com/hL2yQkl.png" width="500" />

Если рассматривать взаимодействие пользователя с веб-приложением глобально, можно выделить следующий процесс:

```
Пользователь вводит данные в форму
    -> Нажимает кнопку отправки
        -> Данные отправляются на сервер
            -> Сервер обрабатывает данные и возвращает ответ
                -> Отображается результат
```

Таким образом, основной процесс взаимодействия с пользователем в веб-приложении сводится к отправке данных на сервер и обновлению интерфейса на основе полученного ответа.

В этой главе мы подробно изучим работу с формами и их использование в веб-приложениях, включая:

- Создание и настройку HTML-форм
- Обработку данных на сервере
- Валидацию пользовательского ввода
- Защиту от различных видов атак

Эти знания помогут вам создавать более удобные и безопасные веб-приложения.

## Атрибуты формы

Рассмотрим базовый пример формы. Вы изучали атрибуты формы в курсе по `HTML`, вспомним основные из них.

```html
<form
  method="post"
  action="/handler.php"
  novalidate
  autocomplete="off"
  enctype="multipart/form-data"
>
  <label for="name">Имя:</label>
  <input type="text" id="name" name="name" required />

  <label for="email">Email:</label>
  <input type="email" id="email" name="email" required />

  <label for="message">Сообщение:</label>
  <textarea id="message" name="message" required></textarea>

  <button type="submit">Отправить</button>
</form>
```

Тег `<form>` объявляет начало HTML-формы. У этого тега есть несколько атрибутов.

**Ключевые атрибуты формы**:

- `method="post"` — метод отправки данных. Может принимать значение `"GET"` или `"POST"`. От этого зависит, как именно браузер отправит данные на сервер. Если метод не указан, по умолчанию используется `GET`.
- `action="/handler"` — адрес серверного скрипта или страницы, на которую отправятся данные формы. Как только пользователь нажимает кнопку отправки, браузер перейдет по этому адресу, передав введенные данные. Обычно здесь указывают файл PHP, который будет обрабатывать данные. Например, `action="hanlder.php"` отправит данные на обработку в файл `handler.php`.
- `novalidate` — отключает встроенную валидацию браузера, что позволяет применять собственную серверную валидацию.
- `autocomplete="off"` — отключает автозаполнение браузером, что полезно для повышения безопасности.
- `enctype="multipart/form-data"` — используется при отправке файлов или бинарных данных.

### Другие атрибуты `<form>`

| Атрибут          | Описание                                                                                           | Пример                                 |
| ---------------- | -------------------------------------------------------------------------------------------------- | -------------------------------------- |
| `target`         | Определяет, где будет открыт ответ (`_blank`, `_self`, `_parent`, `_top`).                         | `<form target="_blank">`               |
| `name`           | Имя формы (может использоваться в JavaScript).                                                     | `<form name="feedback">`               |
| `id`             | Уникальный идентификатор формы (используется для CSS и JS).                                        | `<form id="feedback">`                 |
| `accept-charset` | Указывает кодировку, которую сервер использует для обработки данных.                               | `<form accept-charset="UTF-8">`        |
| `novalidate`     | Отключает встроенную валидацию браузера.                                                           | `<form novalidate>`                    |
| `autocomplete`   | Включает (`on`) или отключает (`off`) автозаполнение формы.                                        | `<form autocomplete="off">`            |
| `enctype`        | Тип кодирования данных (`application/x-www-form-urlencoded`, `multipart/form-data`, `text/plain`). | `<form enctype="multipart/form-data">` |

## Элементы управления формы

Внутри формы мы размещаем поля, куда пользователь вводит информацию. Самый распространенный элемент – тег `<input>`. Он позволяет создавать различные поля ввода, такие как текстовые поля, флажки, радиокнопки и другие. У него есть несколько важных атрибутов:

- `type` – тип поля. Определяет, что это за поле ввода. Самые базовые типы:
  - `"text"` (текстовое поле),
  - `"password"` (парольное поле, вводимые символы скрыты),
  - `"number"` (поле для ввода чисел),
  - `"email"` (поле для ввода email-адреса) и др.
- `name` – имя поля. **Крайне важно!** Имя идентифицирует поле, и именно по этому имени сервер будет потом получать значение. Если у поля нет атрибута name, то значение этого поля не будет передано на сервер.
- `value` – значение по умолчанию (необязательный атрибут, позволяет задать предварительное значение поля, которое пользователь увидит и сможет изменить).

Помимо `<input>`, существуют и другие элементы для ввода, такие как <textarea> (многострочное текстовое поле) или элементы выбора (`<select>`, чекбоксы `<input type="checkbox">`, переключатели `<input type="radio">`). Мы рассмотрим их в следующих главах.

## Отправка формы

Рассмотрим форму для отправки комментария на сайт.

**Пример.** _Форма отправки комментария_

```html
<form action="/handler.php" method="get">
  <label for="name">Имя:</label>
  <input type="text" id="name" name="name" required />

  <label for="email">Email:</label>
  <input type="email" id="email" name="email" required />

  <label for="message">Сообщение:</label>
  <textarea id="message" name="message" required></textarea>

  <button type="submit">Отправить</button>
</form>
```

Когда пользователь заполняет форму и нажимает кнопку **Отправить**, данные из полей ввода отправляются на сервер по указанному URL (`action`). В данном случае, когда пользователь заполнит эти поля и нажмет **"Отправить"**, браузер перейдет по адресу `handler.php`, передав данные из формы

#### Важность атрибута `name`

Как было сказано ранее, атрибут `name` является ключевым для отправки данных на сервер. Он определяет **ключ**, под которым данные будут переданы на сервер. **Например**:

- `name="email"` — данные из этого поля будут отправлены с ключом `email`.

Если пользователь ввёл `email: john@gmail.com`, сервер получит данные в виде пары:

```http
email=john@gmail.com
```

> [!IMPORTANT]
> Если данные не имеют атрибута `name`, они не будут отправлены на сервер.

## Методы отправки данных

HTML-формы поддерживают два основных метода передачи данных (атрибут `method`):

1. **GET**
2. **POST**

### Метод `GET`

> [!NOTE]  
> Метод `GET` используется для получения данных. Он не должен изменять состояние сервера и не подходит для передачи конфиденциальных данных.

Метод `GET` отправляет данные через `URL` (адресную строку). Это означает, что все пары "имя=значение" отправляемых полей приклеиваются к адресу страницы в формате `"query parameters"` (параметры запроса).

#### Что происходит при отправке данных методом `GET`?

1. Предположим, пользователь ввел следующие данные в форму:

   - `name: John`
   - `email: john@gmail.com`
   - `message: Hello World`

2. Браузер берет адрес из `action` (например, `handler.php`) и добавляет к нему вопросительный знак `?`, после которого перечисляет все поля и их значения в формате `имя=значение`, разделяя пары амперсандом `&` если полей несколько

3. В итоге, браузер отправит данные на сервер в виде URL-строки:

   ```http
   https://my-site.com/handler.php?name=John&email=john%40gmail.com&message=Hello%20World
   ```

**В данном примере**:

- `?` — разделитель URL и данных.
- `&` — разделитель между параметрами.
- Спецсимволы (`@`, пробел) кодируются (`%40`, `%20`).

Как упоминалось ранее, ключи данных формируются на основе атрибута `name` каждого поля формы.

<img src="https://imgur.com/WwPdtd1.png" width="500" /> [^1]

#### Характерные особенности метода `GET`

- Данные видны в адресной строке после отправки (их может увидеть пользователь и даже скопировать этот URL).
- Объем данных ограничен длиной URL. В разных браузерах максимальная длина URL может быть разной, но обычно она составляет 2048 символов.
- **Подходит** для **поисковых запросов, фильтров, сортировки**. Например, `/search?query=apple`, `/products?category=phones`, `/products?sort=price`.
- **Не подходит** для **отправки больших данных или конфиденциальной информации**, например паролей. Поскольку данные видны в адресе, они остаются в истории браузера, могут попасть в логи сервера или быть просмотрены посторонними.

### Метод `POST`

> [!NOTE]  
> Метод `POST` используется для отправки данных. Он подходит для передачи больших объёмов информации и защищает данные от утечки в URL.

Метод `POST` отправляет данные _"невидимо"_, в теле HTTP-запроса. При нажатии кнопки браузер формирует запрос к серверу, но параметры не прикрепляет к URL, а вкладывает внутрь (в так называемое _тело запроса_).

#### Что происходит при отправке данных методом `GET`?

1. Предположим, пользователь ввел следующие данные в форму:

   - `name: John`
   - `email: john@gmail.com`
   - `message: Hello World`

2. Браузер обращается на указанный в `action` адрес и отправляет данные в теле запроса:

   ```http
   POST /submit HTTP/1.1
   Content-Type: application/x-www-form-urlencoded

   name=John&email=john@gmail.com&message=Hello%20World
   ```

3. В отличие от `GET`, данные скрыты и не отображаются в URL.

#### Особенности метода POST:

- Данные не видны в адресной строке и не сохраняются в истории. Это более безопасно для передачи, например, паролей или личных сообщений пользователя.
- Нет жесткого ограничения на объем данных (формально ограничение гораздо больше, определяется настройками сервера). Поэтому POST используют для больших форм, файл-аплоадов и т.д.
- URL остается _"чистым"_. Нельзя напрямую поделиться ссылкой с уже заполненными данными.
- **Подходит** для **форм регистрации, авторизации, отправки файлов**.
- **Не подходит**, если данные должны быть доступны через URL (например, для поиска).

### Что выбрать: `GET` или `POST`?

| Метод  | Когда использовать                              | Когда не использовать                                |
| ------ | ----------------------------------------------- | ---------------------------------------------------- |
| `GET`  | Поисковые запросы, фильтры, сортировка          | Отправка больших данных, конфиденциальная информация |
| `POST` | Формы регистрации, авторизации, отправка файлов | Поисковые запросы, фильтры, сортировка               |

## Получение и обработка данных

Мы научились создавать форму и знаем, как она отправляет данные. Теперь переходим к самому важному — приему и обработке данных на стороне сервера с помощью PHP.

Предположим, у нас уже есть HTML-форма (например, как в примере выше), которая отправляет данные на некий PHP-скрипт (в атрибуте `action`). Как же нам вытащить отправленные значения внутри этого скрипта?

### Получение данных из формы

PHP обрабатывает данные, отправленные формой, через **суперглобальные массивы**.

**Суперглобальные массивы** — это массивы в PHP, которые доступны в любом месте скрипта и содержат различные данные, такие как данные формы, заголовки, сессии и другие.

Основные суперглобалы для форм: `$_GET` и `$_POST`. Они автоматически заполняются PHP при переходе на страницу-обработчик:

- Если форма отправлена с `method="get"`, данные будут доступны в массиве `$_GET` (каждое поле: `$_GET['имя_поля']`).
- Если форма отправлена с `method="post"`, данные будут доступны в массиве `$_POST` (каждое поле: `$_POST['имя_поля']`).
- Кроме того, для файлов существует массив `$_FILES`, который рассмотрим в дальнейших главах.

Рассмотрим форму отправки отзыва и получение данных из неё.

**Пример**. _Форма отправки отзыва_

```html
<form action="/handler.php">
  <label for="name">Имя:</label>
  <input type="text" id="name" name="name" required />

  <label for="email">Email:</label>
  <input type="email" id="email" name="email" required />

  <label for="message">Сообщение:</label>
  <textarea id="message" name="message" required></textarea>

  <button type="submit">Отправить</button>
</form>
```

#### Получение данных из формы методом `GET`

Если в форме указан метод `GET` (`<form action="/handler.php" method="get">`), данные будут доступны в массиве `$_GET`.

**Пример**. _Получение данных из формы методом `GET`_

```php
$name = $_GET['name']; // Получаем значение поля name
$email = $_GET['email']; // Получаем значение поля email
$message = $_GET['message']; // Получаем значение поля message
```

#### Получение данных из формы методом `POST`

Если в форме указан метод `POST` (`<form action="/handler.php" method="post">`), данные будут доступны в массиве `$_POST`.

**Пример**. _Получение данных из формы методом `POST`_

```php
// handler.php
$name = $_POST['name']; // Получаем значение поля name
$email = $_POST['email']; // Получаем значение поля email
$message = $_POST['message']; // Получаем значение поля message
```

> [!TIP]
> В PHP разница методов проявляется только в том, из какого массива брать данные (`$_GET` или `$_POST`). _Например_, сменив метод формы c `GET` на `POST`, нужно использовать `$_POST['name']` вместо `$_GET['name']`.

## Обработка данных формы

Обычно PHP-скрипт, обрабатывающий форму, выполняет следующие шаги.

Разберем на примере формы отправки отзыва (_как в примере выше_).

### Проверка, была ли форма отправлена

Перед тем, как обработать данные формы, необходимо проверить, была ли форма отправлена. Есть множество способов проверить, была ли форма отправлена, но наиболее распространенный — проверка если был отправлен запрос методом `POST`.

`$_SERVER` - это суперглобальный массив, который содержит информацию о сервере и текущем запросе. `$_SERVER['REQUEST_METHOD']` содержит метод запроса (GET, POST, PUT, DELETE и т. д.).

```php
// 1. Проверяем, была ли форма отправлена
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
  // Форма отправлена
}
```

### Получение данных из формы

После того, как мы убедились, что форма отправлена, следующим шагом является получение данных из формы. Мы уже рассмотрели, как это сделать с помощью суперглобальных массивов `$_GET` и `$_POST`.

```php
// 1. Проверяем, была ли форма отправлена
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // 2. Получаем данные из формы
    $formData = [
        'name' => $_POST['name'],
        'email' => $_POST['email'],
        'message' => $_POST['message'],
    ];
}
```

### Обработка данных

После получения данных из формы, мы можем их обработать. Например, сохранить в базу данных, отправить на почту, вывести на экран и т. д.

```php
// 1. Проверяем, была ли форма отправлена
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // 2. Получаем данные из формы
    $formData = [
        'name' => $_POST['name'],
        'email' => $_POST['email'],
        'message' => $_POST['message'],
    ];

    // 4. Делаем что-то с данными
    // Например, сохраняем в базу данных
    // Или отправляем на почту
    // Или выводим на экран
}
```

### Отправка ответа

После обработки данных, мы можем отправить ответ пользователю. Например, вывести сообщение об успешной отправке или перенаправить на другую страницу.

```php
// 1. Проверяем, была ли форма отправлена
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // 2. Получаем данные из формы
    $formData = [
        'name' => $_POST['name'],
        'email' => $_POST['email'],
        'message' => $_POST['message'],
    ];

    // 4. Делаем что-то с данными
    // Например, сохраняем в базу данных
    // Или отправляем на почту
    // Или выводим на экран

    // 5. Отправляем ответ пользователю
    echo 'Данные успешно отправлены!';
}
```

### Где именно обрабатывать данные?

Выше был рассмотрен обработчик формы. Первый вопрос, который может возникнуть: _в каком именно месте принимать данные_? То есть, что именно указать в атрибуте `action` формы?

> [!TIP]
> Напомним, что атрибут `action` формы указывает URL, куда отправляются данные.

Есть множество хороших практик, пока не изучены другие принципы разработки веб-приложений, рекомендуется обрабатывать данные формы в том же файле, где находится сама форма. Это позволит нам быстро протестировать отправку данных и убедиться, что всё работает корректно.

**Пример**. _Обработка данных формы в том же файле_

```php
<?php
// index.php

// 1. Проверяем, была ли форма отправлена
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // 2. Получаем данные из формы
    $formData = [
        'name' => $_POST['name'],
        'email' => $_POST['email'],
        'message' => $_POST['message'],
    ];

    // 4. Делаем что-то с данными
    // Например, сохраняем в базу данных
    // Или отправляем на почту
    // Или выводим на экран
}
?>
```

При желании можно вынести обработку данных в отдельный файл, например, `handler.php`, подключив его к основному файлу с формой.

**Пример**. _Обработка данных формы в отдельном файле_

```php
<?php

// handler.php

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $formData = [
        'name' => $_POST['name'],
        'email' => $_POST['email'],
        'message' => $_POST['message'],
    ];

    // Делаем что-то с данными
    // Например, сохраняем в базу данных
    // Или отправляем на почту
    // Или выводим на экран
}
?>
```

```php
<?php
// index.php

// Подключаем обработчик
require_once 'handler.php';
?>

<!-- Форма -->
<form action="/index.php" method="post">
  <!-- Поля формы -->
</form>
```

Очень частой практикой является указание `action` с помощью суперглобального массива `$_SERVER['PHP_SELF']`. Это позволяет отправлять данные на тот же файл, где находится форма.

Если форма находится в файле `index.php`, то `$_SERVER['PHP_SELF']` вернет `/index.php`.
Если форма находится в файле `handler.php`, то `$_SERVER['PHP_SELF']` вернет `/handler.php`.

То есть, если сменится адрес файла, форма будет отправлять данные на новый адрес.

**Пример**. _Использование `$_SERVER['PHP_SELF']`_

```php
<?php require_once 'handler.php'; ?>

<form action="<?php echo $_SERVER['PHP_SELF']; ?>" method="post">
  <!-- Поля формы -->
</form>
```

[^1]: _HTML Form_. programiz [online resource]. Available at: https://www.programiz.com/html/form
